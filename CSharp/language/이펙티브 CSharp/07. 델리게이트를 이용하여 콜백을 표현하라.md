# Item 7. 델리게이트를 이용하여 콜백을 표현하라
> Chapter 1. 언어 요소

- 콜백은 서버가 클라이언트에게 비동기적으로 피드백을 주기 위해서 사용하는 방법이다.
- C# 에서 콜백은 델리게이트를 이용하여 표현된다.
- 델리게이트를 이용하면 타입 안정적인 콜백을 정리할 수 있다.
- 대부분의 경우에 델리게이트는 `event`와 함께 사용되지만 반드시 그래야 하는 것은 아니다.
- 여러 클래스가 상호 통신을 수행해야 할 때 클래스 간의 결합도를 낮추고 싶다면 인터페이스보다는 델리게이트를 사용하는 것이 좋다.
- 델리게이트는 런타임에 통지 대상을 설정할 수 있고, 다수의 클라이언트에게 통지를 보낼수도 있다. 하나의 델리게이트는 여러 메서드에 대한 참조를 포함할 수 있기 때문이다.

- `.NET Framework` 라이브러리는 자주쓰는 델리게이트를 정의 해 두고 있다.
  - `Predict<T>` : 조건을 검사하여 부울값을 반환하는 델리게이트
  - `Func<T>` : 여러 개의 매개변수를 받아 단일의 결괏값을 반환하는 델리게이트
  - `Action<>` : 여러 개의 매개변수를 받지만 반환 타입이 void인 델리게이트

- `List<T>`는 콜백을 사용하는 다양한 메서드를 가지고 있다.

```c#
List<int> numbers = Enumerable.Range(1, 200).ToList();

var oddNumbers = numbers.Find(n => n%2 == 1);
var test = numbers.TrueForAll(n => n < 50);

numbers.RemoveAll(n => n%2 == 0);

numbers.ForEach(item => Console.WriteLine(item));
```

- `LINQ`는 모두 델리게이트를 기반으로 한다.
- `WPF`나 `Winforms`에서 여러 스레드를 넘나들 경우 반드시 마샬링이 필요한데, 이 경우에도 콜백이 사용된다.
- `.NET Framework`에서 매개변수로 단일 메서드를 필요로 하는 모든 경우에 람다 표현식을 쓸 수 있도록 델리게이트를 사용한다.

- 역사적인 이유로 모든 델리게이트는 기본적으로 멀티캐스트가 가능하다.
- 주의해야 할 부분이 있다.
  - **예외에 안전하지 않다** : 중간에 예외가 발생하면 델리게이트는 어떤 예외도 잡지 않으며, 예외가 발생하면 함수 호출 과정이 중단된다.
  - **마지막으로 호출된 대상 함수의 반환값이 델리게이트의 반환값으로 간주된다.**

```c#
public void LengthyOperation(Func<bool> pred)
{
    bool bContinue = true;
    foreach (ComplicatedClass cl in container)
    {
        cl.DoLengthyOperation();
        foreach (Func<bool> pr in pred.GetInvocationList())
        {
            bContinue &= pr();
        }
        if (!bContinue)
        {
            return;
        }
    }
}
```
- 위 코드처럼 델리게이트에 추가된 개별 메서드가 true를 반환한 경우에만 다음 메서드에 대한 호출을 이어가도록 할 수 있다.

</br>

- 델리게이트는 런타임에 콜백을 구성하는 최고의 방법이다.
- 델리게이트를 사용하면 콜백을 사용해야 하는 클라이언트를 더욱 단순하게 구성할 수 있을 뿐 아니라 런타임에 콜백 함수를 구성할 수 있다.
- 게다가 하나의 델리게이트에 여러 개의 콜백 함수를 추가할 수도 있다.
- .NET 환경에서 콜백이 필요한 경우에는 반드시 델리게이트를 사용하자.
